# Real-Time Ranking API

This project is a microservice built in Go that provides real-time video ranking based on user interactions. It leverages Redis for dynamic leaderboard updates and PostgreSQL for persistent storage of users and videos metadata. API documentation is defined in an OpenAPI (Swagger) YAML file and generated via oapi-codegen. A ReDoc-based Swagger UI is served at `/docs` for interactive API exploration.

---

## Table of Contents

- [Features](#features)
- [Architecture](#architecture)
- [Prerequisites](#prerequisites)
- [Project Structure](#project-structure)
- [Configuration](#configuration)
- [Build & Run](#build--run)
- [Docker & Docker Compose](#docker--docker-compose)
- [API Endpoints](#api-endpoints)
- [Swagger Documentation](#swagger-documentation)
- [Testing](#testing)
- [Technical Notes](#technical-notes)
- [Additional Notes](#additional-notes)
---

## Features

- **Real-time ranking**:
    - Global and per-user video ranking managed in Redis using sorted sets.
- **CRUD API**:
    - Create, Retrieve, Update, and Delete for **Users** and **Videos**.
- **Interactions**:
    - Endpoint to record user interactions (views, likes, comments, shares, and watch time) and update video scores accordingly.
- **API Documentation**:
    - OpenAPI (Swagger) spec provided in `docs/openapi.yaml` with ReDoc UI served at `/docs`.
- **Graceful Shutdown**:
    - Clean shutdown of HTTP server and connections via ORY graceful.
- **Integration**:
    - Integration tests using [miniredis](https://github.com/alicebob/miniredis) for Redis.

---

## Architecture

### Layers

- **Handler Layer** (`/internal/handler`):  
  Contains HTTP handlers generated with oapi-codegen and custom implementations for each endpoint.

- **Service Layer** (`/internal/service`):  
  Contains business logic, including calculation of video scores and operations to retrieve or update video rankings (from Redis) and integrate with Datasource layer.

- **Datasource Layer** (`/internal/db`):  
  Provides CRUD operations on users and videos (via Bun ORM on PostgreSQL).

- **Model Layer** (`/internal/models`):  
  Contains domain models for users, videos, and video rankings.

- **Cache Layer** (`/internal/cache`):  
  Provides a Redis client for real-time ranking and caching functionality.

- **Configuration and Bootstrapping** (`/internal/config` & `/internal/app`):  
  Loads configuration from a YAML file (`config.yaml`) and initializes services.

- **API Documentation** (`docs/openapi.yaml`):  
  OpenAPI spec for the RESTful APIs, used to generate server stubs with oapi-codegen.

- **Docker** (`docker-compose.yml`, `Dockerfile`):  
  Containerizes the Go application, along with a Redis instance. PostgreSQL is used as the persistent data store and can be configured separately.

---
## Prerequisites

- **Go 1.24** or later
- **PostgreSQL** (or use Docker for local development)
- **Redis**
- **Podman** or **Docker Compose** (for containerization)
- [oapi-codegen](https://github.com/deepmap/oapi-codegen) (to generate Go code from OpenAPI spec)

---

## Project Structure
```
real-time-ranking/ 
├── cmd/ 
│ └── main.go # Entry point for the API server. 
├── docs/ 
│ └── openapi.yaml # OpenAPI specification. 
│ └── cfg.yaml # Oapi-codegen configuration. 
│ └── index.html # Serve Swagger documentation.
├── internal/ 
│ ├── app/ # Application initialization logic. 
│ ├── cache/ # Redis client and helper functions. 
│ ├── config/ # Configuration loader (e.g., config.yaml). 
│ ├── db/ # Database repository implementations. 
│ ├── handler/ # Generated API stubs and implementations.
│ │ ├── gen.go # Generated by oapi-codegen. 
│ │ └── handler.go # Custom handler implementations. 
│ ├── model/ # Domain models (User, Video, etc.). 
│ └── server/ # Server logic. 
│ └── service/ # Business logic for videos, users, interactions. 
├── config.yaml # Project configuration. 
├── docker-compose.yml # Docker Compose file for local development. 
├── Dockerfile # Build and run the Go app. 
├── go.mod 
└── Makefile
└── README.md
└── sequence-diagram.puml
```

---

## Configuration

The application loads its configuration from a YAML file (e.g., `config.yaml`).  
Example configuration (`config.yaml`):

```yaml
app:
  logging_level: DEBUG
  port: :8080
redis:
  connection_string: redis:6379  # When running in Docker, use service name.
database:
  dsn: "postgres://username:password@localhost:5432/real_time_ranking?sslmode=disable"
  debug: true
 ```
Environment variables can also be used to override these settings.

---

## Build & Run

| Command      | Description                                                  |
|--------------|--------------------------------------------------------------|
| `make oapi`  | Generate (update) API code from OpenAPI YAML (`docs/`)       |
| `make test`  | Run all Go tests                                             |
| `make build` | Build the Go binary (`main`)                                 |
| `make run`   | Run the app directly with `go run`                           |
| `make all`   | Run all: Generate code, Build binary, run tests, and run app |

Your API server will listen on the port configured (default is 8080).
Visit http://localhost:8080/docs to view the API documentation via ReDoc.

---

## Docker & Docker Compose
To build and run containers:
```
docker-compose up --build
```
To shut them down:
```
docker-compose down
```

---

## API Endpoints

### Users
- **POST /users**
  - Create a new user.

- **GET /users/{id}**
  - Get user details.

- **PUT /users/{id}**
  - Update user details.

- **DELETE /users/{id}**
  - Delete a user.

### Videos
- **POST /videos**
  - Create a new video.

- **GET /videos/{id}**
  - Retrieve video details.

- **PUT /videos/{id}**
  - Update video metadata.

- **DELETE /videos/{id}**
  - Delete a video.

- **PATCH /videos/{id}/reactions**
  - Update video reactions such as likes, comments, shares, views, and watch_time. 

### Rankings
- **GET /rankings/{top}**
  - Get global video rankings (top N videos).

- **GET /rankings/{top}/{userID}**
  - Get personalized video rankings for a user.

---

## Swagger Documentation
OpenAPI YAML is located at `docs/openapi.yaml` and is used to generate API definitions with `oapi-codegen`.
Swagger documentation is served at http://localhost:8080/docs.

---

## Testing
Run tests as:
```
make test
```
Note: Integration tests use miniredis and Repository pattern for PostgreSQL.

---

## Technical Notes

### Assumptions & Design Decisions

- **Video Ranking Logic**:  
  The ranking score for a video is dynamically calculated in Redis based on interactions such as views, likes, comments, shares, and watch time. We assume:
    - Not all interactions have equal weight.
    - These weights can be tuned dynamically via the service layer or environment/config later.
    - Rankings are kept in Redis to support high-throughput access patterns, not PostgreSQL.

- **Redis Sorted Sets**:  
  Redis is used for both global and per-user rankings using sorted sets (`ZADD`, `ZRANGE`, etc.). The score is recalculated and updated every time a user interacts with a video.

- **User Authentication/OAuth**:  
  The current version assumes users are authenticated externally (i.e., no JWT or OAuth handling is implemented inside this service).

- **No Soft Deletes**:  
  Deletes are hard deletes for simplicity. In future versions, we might add soft-deletes with `deleted_at` timestamps.

- **OpenAPI-first**:  
  API design follows an OpenAPI-first approach, and all handlers are generated with `oapi-codegen` to ensure contract consistency between frontend/backend.

- **Redis as a Singleton**:  
  Redis client is instantiated once (singleton) and reused across services via dependency injection.

- **Lightweight config system**:  
  Configuration is centralized in a `config.yaml`, loaded via Viper or a similar package.

---

### Known Issues / Limitations

- **Persistence for Rankings**:  
  Rankings exist only in Redis. If Redis is flushed or unavailable, rankings will be lost unless rebuilt from historical data (which we currently don’t persist for interactions).

- **Scalability**:  
  This service currently runs as a monolith. Redis bottlenecks and horizontal scaling considerations (e.g., Redis Cluster, consistent hashing) are not implemented yet.

- **No Auth Middleware**:  
  API has no built-in authentication/authorization layer. It's expected to be handled by an API Gateway or another service.

- **User Preferences**:  
  Personalized ranking assumes interaction data exists. Cold-start users or videos will not be ranked appropriately without bootstrapping logic.

- **Rate Limiting & Spam Prevention**:  
  There’s no protection against spam interactions or repeated interaction abuse. This can affect ranking accuracy.

- **No Background Job for Score Recalculation**:  
  All score updates happen synchronously. Future improvements may involve queuing with background workers (e.g., using RabbitMQ or Go workers).

---

### Design Patterns Used

| Pattern        | Usage Context                                                                 |
|----------------|-------------------------------------------------------------------------------|
| **Repository** | Abstracts database operations for users and videos (via Bun or SQL builder). |
| **Singleton**  | Redis client and PostgreSQL connection are initialized once and shared.       |
| **Factory**    | Used internally to initialize service layers and handler instances cleanly.   |
| **Adapter**    | Redis ZSet logic and cache access is encapsulated via adapter-style wrappers. |
| **Dependency Injection (DI)** | Services and handlers are wired with injected dependencies to keep modules testable. |

---

### Principles Followed

| Principle       | How it’s applied                                                                 |
|-----------------|----------------------------------------------------------------------------------|
| **KISS**         | We keep business logic centralized and avoid overly complex abstractions.       |
| **DRY**          | Shared logic like score calculations, validation, and logging are centralized.  |
| **Separation of Concerns** | Layers (handler, service, model) are clearly separated.                  |
| **Single Responsibility** | Each struct/function handles exactly one responsibility.                 |
| **Open/Closed Principle** | The ranking algorithm can be extended without modifying core logic.     |
| **Fail Fast**     | Invalid input is rejected early in the request cycle with clear error responses.|

---

## Additional Notes
- **Graceful Shutdown**: The server uses ORY graceful to shutdown connections (Redis, PostgreSQL, etc.) cleanly.

- **Configuration**: The service loads configuration from a YAML file (`config.yaml`). Adjust the environment variables in your deployment as needed.

- **Redis & PostgreSQL**: The application uses Redis for real-time ranking and PostgreSQL for persisting user and video data.

- **OpenAPI Code Generation**: We use `oapi-codegen` to generate types and HTTP server bindings from the `docs/openapi.yaml`.

---
